<template class="task-template">
  <section id="ver-carreras-section" class="section js-section u-category-native-ui">
    <header class="communication">
      <div class="section-wrapper">
        <h1>
          <svg class="section-icon"><use xlink:href="assets/img/icons.svg#icon-native-ui"></use></svg>
          Ver Carreras
        </h1>
        <h3>Carreras</h3>
      </div>
    </header>
    <table  columns="2">
      <tr>
        <td>
          <select id="select-carreras"  style="width:250px;"  placeholder="Elegir Carrera..."></select>
        </td>
        <td>
          <div id="terminado"></div>
        </td>
      </tr>
    </table>

    <button class="boton" onclick="onBtPrint()"  id="botonImprimir"  >Imprimir</button>
    INSCRIPTOS
    <div id="gridCorredoresCarreraV" disabled style="height: 350px;width:650px;" class="ag-theme-balham my-grid"></div>


    <script >



      var idCarrera_v;
      var carreraTerminada_v;
      var gridOptionsCarrerasV;


      var selectCarreras_v = $('#select-carreras').selectize({
        maxItems: 1,
        valueField: 'id',
        labelField: 'nombre',
        searchField: 'nombre',
        onChange:function(value){
          idCarrera_v = value;
          refrescarTablaVerCarrera();
        },
        create: false
      });

      var selectizeCarreras_v = selectCarreras_v[0].selectize;
      refreshListaCarrerasVer();

      function refreshListaCarrerasVer(){
        getCarreras_v(function (err, result){
          selectizeCarreras_v.addOption(result);
          selectizeCarreras_v.refreshOptions();
        });
      }


      function getCarreras_v(callback){
        query =  'SELECT * FROM carreras_view';
        sqlQuery(callback, query);
      }


      //SETUP TABLA
      // specify the columns
      var columnDefsCarreras_v = [
      {headerName: "Global", field: "global", sortable: true, width:60},
      {headerName: "Pos", field: "posicion", sortable: true, width:50},
      //{lockPosition: true, valueGetter: 'node.rowIndex+1', cellClass: 'locked-col', width: 70, headerName: 'Posici√≥n', suppressNavigable: true},
      {headerName: "Nombre", field: "nombre", width:100},
      {headerName: "Apellido", field: "apellido", width:110},
      {headerName: "Pechera", field: "numero", filter: true, width:85},
      {headerName: "Categoria", field: "categoria", sortable: true, filter: true, width:95},
      {headerName: "Tiempo", field: "tiempo", width:80},
      {headerName: "Vueltas", field: "vueltas", width:65}
      ];

      // let the grid know which columns and what data to use
      var gridOptionsCarrerasV = {
        defaultColDef: {
          resizable: false
        },
        columnDefs: columnDefsCarreras_v,
        floatingFilter: false,
        localeText: {
          // for text filter
          contains: 'contiene',
          notContains: 'no contiene',
          startsWith: 'empieza con',
          endsWith: 'termina con',

          // for number filter and text filter
          filterOoo: 'filtrar...',
          applyFilter: 'aplicar filtro...',
          equals: 'igual',
          notEquals: 'distinto',

          // other
          noRowsToShow: 'No hay registros para mostrar  ',
          loadingOoo: 'Cargando...',

          // filter conditions
          andCondition: 'Y',
          orCondition: 'O',
        },
        animateRows: true,
        toolPanelSuppressSideButtons: true,
        groupUseEntireRow: true,
        onGridReady: function(params) {
          params.api.expandAll();
        }
      };
      var eGridDivCarreras_v = document.querySelector('#gridCorredoresCarreraV');
      refrescarTablaVerCarrera();
      new agGrid.Grid(eGridDivCarreras_v, gridOptionsCarrerasV);

      function refrescarTablaVerCarrera(){
        var queryCorredores = 'SELECT * FROM carrera_corredor_view WHERE id_carrera='+idCarrera_v;
        sqlQuery(function (err, result){
          gridOptionsCarrerasV.api.setRowData(result);
        }, queryCorredores);
      }



      function onBtPrint() {
        window.jsPDF = require('jspdf');
        window.autoTable = require('jspdf-autotable');


        var pdf = new jsPDF('p', 'pt', 'letter');
        // source can be HTML-formatted string, or a reference
        // to an actual DOM element from which the text will be scraped.
        var queryCorredores = 'SELECT global, nombre, apellido, numero, categoria, tiempo, vueltas  FROM carrera_corredor_view WHERE id_carrera='+idCarrera_v;
        sqlQuery(function (err, result){

          /* var columns = ["General", "Nombre", "Apellido", "Pechera","Categoria","Tiempo","Vueltas"];
          specialElementHandlers = {
              // element with id of "bypass" - jQuery style selector
              '#bypassme': function (element, renderer) {
                  // true = "handled elsewhere, bypass text extraction"
                  return true
              }
          };*/
          var columns = [
                {title: "General", dataKey: "global"},
                {title: "Nombre", dataKey: "nombre"},
                {title: "Apellido", dataKey: "apellido"},
                {title: "Pechera", dataKey: "numero"},
                {title: "Categoria", dataKey: "categoria"},
                {title: "Tiempo", dataKey: "tiempo"},
                {title: "Vueltas", dataKey: "vueltas"}
            ];

          console.log(result);

          margins = {
              top: 80,
              bottom: 60,
              left: 40,
              width: 522
          };
            pdf.autoTable(columns,result,{ margin:{ top: 25  }});
            pdf.save('mipdf.pdf');
        }, queryCorredores);

  }



//FUNCION DE CONSULTAS A MYSQL
function sqlQuery(callback, queryString){
  var mysql = require('mysql');
  var connection = mysql.createConnection({
    host     : 'localhost',
    user     : 'root',
    password : null,
    database : 'bicisoft'
  });

  connection.connect(function(err) {
    if(err){
      console.log(err.code);
      console.log(err.fatal);
    }
  });
  console.log("performing query");
  // Perform a query

  connection.query(queryString, function(err, rows, fields) {
    if(err){

      if(err.code == 'ER_DUP_ENTRY' || err.errno == 1062){
        console.log('REGISTRO DUPLICADO');
      }
      else{
        console.log("OCURRIO UN ERROR SQL.");
        console.log(err);
      }

      return;
    }
    callback(err, rows);
  });
  // Close the connection
  connection.end(function(){
    // The connection has been closed
  });
}

</script>
</section>
</template>
