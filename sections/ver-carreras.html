<template class="task-template">
  <section id="ver-carreras-section" class="section js-section u-category-native-ui">
    <header class="communication">
      <div class="section-wrapper">
        <h1>
          <svg class="section-icon"><use xlink:href="assets/img/icons.svg#icon-native-ui"></use></svg>
          Ver Carreras
        </h1>
        <h3>Carreras</h3>
      </div>
    </header>
    <table  columns="2">
      <tr>
        <td>
          <select id="select-carreras"  style="width:250px;"  placeholder="Elegir Carrera..."></select>
        </td>
        <td>
          <div id="terminado"></div>
        </td>
      </tr>
      </table>
    <div >


    </div>
    INSCRIPTOS

    <div id="ccGrid" disabled style="height: 350px;width:650px;" class="ag-theme-balham"></div>



    <script type="text/javascript" charset="utf-8">
      var $idCarrera;
      var $carreraTerminada;


    /*  function inscribirCarrera(){

    }*/



      var $selectCarreras = $('#select-carreras').selectize({
        maxItems: 1,
        valueField: 'id',
        labelField: 'nombre',
        searchField: 'terminada',
        onChange:function(value){
          $idCarrera = value;

          habilitarInscripcion();
          //se refrescan los datos de la tabla cuando cambia la seleccion en la lista
          getCorredoresCarrera(function (err, result){
            gridOptionsCarreras.api.setRowData(result);
          });

          //se pone la fecha
          //$('#fecha').append('<div><span class="name">' + this.fecha + '</span></div>');
        },
        create: false

      });

      var selectizeCarreras = $selectCarreras[0].selectize;


      getCarreras(function (err, result){
        selectizeCarreras.addOption(result);
        selectizeCarreras.refreshOptions();
      });

      function getCarreras(callback){
        var mysql = require('mysql');
        var connection = mysql.createConnection({
          host     : 'localhost',
          user     : 'root',
          password : null,
          database : 'bicisoft'
        });

        connection.connect(function(err) {
          if(err){
            console.log(err.code);
            console.log(err.fatal);
          }
        });
        console.log("performing query");
        // Perform a query
        $query = 'SELECT * FROM carreras_view';
        connection.query($query, function(err, rows, fields) {
          if(err){
            console.log("An error ocurred performing the query.");
            console.log(err);
            return;
          }
          console.log("Query categorias succesfully executed");
          callback(err, rows);


        });

        // Close the connection
        connection.end(function(){
          // The connection has been closed
        });
      }


      function habilitarInscripcion(){
        var mysql = require('mysql');
        var connection = mysql.createConnection({
          host     : 'localhost',
          user     : 'root',
          password : null,
          database : 'bicisoft'
        });
        var $isCarreraTerminada = false;
        connection.connect(function(err) {
          if(err){
            console.log(err.code);
            console.log(err.fatal);
          }
        });
        // Perform a query
          console.log("consulta de la CUENTA");
        $query = 'SELECT count(*) as cuenta FROM carreras WHERE id='+$idCarrera+' AND terminada = 0 ' ;
        connection.query($query, function(err, rows, fields) {
          if(err){
            console.log("An error ocurred performing the query.");
            console.log(err);
            return;
          }
            //console.log("consulta realizada de la CUENTA");
            if (rows[0].cuenta==0){

              document.getElementById("terminado").innerHTML = "Carrera Finalizada";
            }else{

              document.getElementById("terminado").innerHTML = "";
            }
      });
    }


      //EMPIEZA configuracion TABLA
      // specify the columns
      var columnDefsCarreras = [
      {headerName: "documento", field: "documento"},
      {headerName: "nombre", field: "nombre"},
      {headerName: "apellido", field: "apellido", sortable: true, filter: true},
      {headerName: "categoria", field: "categoria", sortable: true, filter: true}
      ];

      // let the grid know which columns and what data to use
      var gridOptionsCarreras = {
        defaultColDef: {
          width: 110,
          resizable: true
        },
        columnDefs: columnDefsCarreras,
      };

      // lookup the container we want the Grid to use
      var eGridDivCarreras = document.querySelector('#ccGrid');

      getCorredoresCarrera(function (err, result){
        gridOptionsCarreras.api.setRowData(result);
      });

      new agGrid.Grid(eGridDivCarreras, gridOptionsCarreras);


      //nuevo
      function getCorredoresCarrera(callback){
        var mysql = require('mysql');
        var connection = mysql.createConnection({
          host     : 'localhost',
          user     : 'root',
          password : null,
          database : 'bicisoft'
        });

        connection.connect(function(err) {
          if(err){
            console.log(err.code);
            console.log(err.fatal);
          }
        });
        // Perform a query
        $query = 'SELECT * FROM carrera_corredor_view WHERE id_carrera='+$idCarrera;
        connection.query($query, function(err, rows, fields) {
          if(err){
            console.log("An error ocurred performing the query.");
            console.log(err);
            return;
          }
          callback(err, rows);


        });

        // Close the connection
        connection.end(function(){
          // The connection has been closed
        });
      }




    </script>


  </section>
</template>
