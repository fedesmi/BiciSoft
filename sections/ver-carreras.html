<template class="task-template">
  <section id="ver-carreras-section" class="section js-section u-category-native-ui">
    <header class="communication">
      <div class="section-wrapper">
        <h1>
          <svg class="section-icon"><use xlink:href="assets/img/icons.svg#icon-native-ui"></use></svg>
          Ver Carreras
        </h1>
        <h3>Carreras</h3>
      </div>
    </header>
    <table  columns="2">
      <tr>
        <td>
          <select id="select-carreras"  style="width:250px;"  placeholder="Elegir Carrera..."></select>
        </td>
        <td>
          <div id="terminado"></div>
        </td>
      </tr>
    </table>

    <button class="boton" onclick="onBtPrint()"  id="botonImprimir"  >Imprimir</button>
    INSCRIPTOS
    <div id="gridCorredoresCarreraV" disabled style="height: 350px;width:650px;" class="ag-theme-balham my-grid"></div>


    <script >



      var idCarrera_v;
      var carreraTerminada_v;
      var gridOptionsCarrerasV;


      var selectCarreras_v = $('#select-carreras').selectize({
        maxItems: 1,
        valueField: 'id',
        labelField: 'nombre',
        searchField: 'nombre',
        onChange:function(value){
          idCarrera_v = value;
          refrescarTablaVerCarrera();
        },
        create: false
      });

      var selectizeCarreras_v = selectCarreras_v[0].selectize;
      refreshListaCarrerasVer();

      function refreshListaCarrerasVer(){
        getCarreras_v(function (err, result){
          selectizeCarreras_v.addOption(result);
          selectizeCarreras_v.refreshOptions();
        });
      }


      function getCarreras_v(callback){
        query =  'SELECT * FROM carreras_view';
        sqlQuery(callback, query);
      }


      //SETUP TABLA
      // specify the columns
      var columnDefsCarreras_v = [
      {headerName: "Global", field: "global", sortable: true, width:60},
      {headerName: "Pos", field: "posicion", sortable: true, width:50},
      //{lockPosition: true, valueGetter: 'node.rowIndex+1', cellClass: 'locked-col', width: 70, headerName: 'Posici√≥n', suppressNavigable: true},
      {headerName: "Nombre", field: "nombre", width:100},
      {headerName: "Apellido", field: "apellido", width:110},
      {headerName: "Pechera", field: "numero", filter: true, width:85},
      {headerName: "Categoria", field: "categoria", sortable: true, filter: true, width:95},
      {headerName: "Tiempo", field: "tiempo", width:80},
      {headerName: "Vueltas", field: "vueltas", width:65}
      ];

      // let the grid know which columns and what data to use
      var gridOptionsCarrerasV = {
        defaultColDef: {
          resizable: false
        },
        columnDefs: columnDefsCarreras_v,
        floatingFilter: false,
        localeText: {
          // for text filter
          contains: 'contiene',
          notContains: 'no contiene',
          startsWith: 'empieza con',
          endsWith: 'termina con',

          // for number filter and text filter
          filterOoo: 'filtrar...',
          applyFilter: 'aplicar filtro...',
          equals: 'igual',
          notEquals: 'distinto',

          // other
          noRowsToShow: 'No hay registros para mostrar  ',
          loadingOoo: 'Cargando...',

          // filter conditions
          andCondition: 'Y',
          orCondition: 'O',
        },
        animateRows: true,
        toolPanelSuppressSideButtons: true,
        groupUseEntireRow: true,
        onGridReady: function(params) {
          params.api.expandAll();
        }
      };
      var eGridDivCarreras_v = document.querySelector('#gridCorredoresCarreraV');
      refrescarTablaVerCarrera();
      new agGrid.Grid(eGridDivCarreras_v, gridOptionsCarrerasV);

      function refrescarTablaVerCarrera(){
        var queryCorredores = 'SELECT * FROM carrera_corredor_view WHERE id_carrera='+idCarrera_v;
        sqlQuery(function (err, result){
          gridOptionsCarrerasV.api.setRowData(result);
        }, queryCorredores);
      }




      /**/
      function onBtPrint() {
        let remote = require('electron').remote
        var fs = require('fs')
        remote.getCurrentWindow().webContents.printToPDF({printBackground: true, landscape: true}, function (error, data) {
          if (error) throw error
          fs.writeFile('C:\\print.pdf', data, function (error) {
            if (error) {
              throw error
            }
            shell.openExternal('file://' + pdfPath)
            event.sender.send('wrote-pdf', pdfPath)
          })
        })
      }


      /* foto de la tabla FUNCIONANDO JQUERY
      function print() {
      html2canvas($('#gridCorredoresCarreraV'), {
      onrendered: function(canvas) {

      var saveAs = function(uri, filename) {
      var link = document.createElement('a');
      if (typeof link.download === 'string') {
      document.body.appendChild(link); // Firefox requires the link to be in the body
      link.download = filename;
      link.href = uri;
      link.click();
      document.body.removeChild(link); // remove the link when done
    } else {
    location.replace(uri);
  }
};

var img = canvas.toDataURL("image/png"),
uri = img.replace(/^data:image\/[^;]/, 'data:application/octet-stream');

saveAs(uri, 'tableExport.png');
}
});
}*/

//FUNCION DE CONSULTAS A MYSQL
function sqlQuery(callback, queryString){
  var mysql = require('mysql');
  var connection = mysql.createConnection({
    host     : 'localhost',
    user     : 'root',
    password : null,
    database : 'bicisoft'
  });

  connection.connect(function(err) {
    if(err){
      console.log(err.code);
      console.log(err.fatal);
    }
  });
  console.log("performing query");
  // Perform a query

  connection.query(queryString, function(err, rows, fields) {
    if(err){

      if(err.code == 'ER_DUP_ENTRY' || err.errno == 1062){
        console.log('REGISTRO DUPLICADO');
      }
      else{
        console.log("OCURRIO UN ERROR SQL.");
        console.log(err);
      }

      return;
    }
    callback(err, rows);
  });
  // Close the connection
  connection.end(function(){
    // The connection has been closed
  });
}

</script>
</section>
</template>
