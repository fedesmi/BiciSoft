<template class="task-template">
  <section id="carrera-section" class="section js-section u-category-native-ui">





    <header class="communication">
      <div class="section-wrapper">
        <h1>
          <img class="section-icon" src="assets/img/crono.png">
          Carrera en curso
        </h1>

      </div>
    </header>


    <table columns="2">
      <tr class="trinput">
        <td>Tipo</td>
        <td class="tdinput"><select id="select-carreras-correr"  style="width:250px;"  placeholder="Elegir Carrera..."></select></td>
        <td class="tdinput"><button class="boton" onclick="manejarCarrera()"  id="botonEmpezar"  >Empezar</button></td>
      </tr>
      <tr class="trinput">
        <td>Marcar #</td>
        <td class="tdinput"><input type="text" id="marcarField" class="input" name="background" onkeypress="manejarMarca(event)" placeholder="enter para marcar"></td>
      </tr>

    </table>

    <div id="gridCorredoresCarreras" disabled style="height: 350px;width:700px;" class="ag-theme-balham"></div>

    <script>
      function manejarCarrera(){
        if (document.getElementById("botonEmpezar").innerHTML === "Terminar"){
          terminarCarrera();
        }
        else {
          empezarCarrera();
        }
      }

      function empezarCarrera(){
        //MARCAR INICIO CORREDORES SEGUN TIPO DE CARRERA
        document.getElementById("botonEmpezar").innerHTML = "Terminar";
        $('#select-carreras-correr')[0].selectize.disable();
      }

      function terminarCarrera(){
        // MARCAR CARRERA TERMINADA (AVISAR QUE QUEDAN CORREDORES SIN FINALIZAR
        //Y SE TOMARAN EN CUENTA COMO DESCALIFICADOS).
        
        document.getElementById("botonEmpezar").innerHTML ="Empezar";
        $('#select-carreras-correr')[0].selectize.enable();

      }



      function manejarMarca(event){
        if (event.keyCode===13){
          document.getElementById("marcarField").innerHTML ="";
        }

      }


    </script>








    <script type="text/javascript" charset="utf-8">
      /*AG GRID DE CARRERAS Y CORREDORES*/


      var $idCarreraCorrer;

      var $selectCarrerasCorrer = $('#select-carreras-correr').selectize({
        maxItems: 1,
        valueField: 'id',
        labelField: 'nombre',
        searchField: 'nombre',
        onChange:function(value){
          //console.log("funcionvalue"+value);
          $idCarreraCorrer = value;
          //se refrescan los datos de la tabla cuando cambia la seleccion en la lista
          getCorredoresCarreras(function (err, result){
            gridOptionsCarrerasCorredores.api.setRowData(result);
          });

          //se pone la fecha
          //$('#fecha').append('<div><span class="name">' + this.fecha + '</span></div>');

          console.log("funcion value "+$idCarreraCorrer);
        },
        create: false

      });

      var selectizeCarrerasCorrer = $selectCarrerasCorrer[0].selectize;


      getCarrerasCorrer(function (err, result){
        selectizeCarrerasCorrer.addOption(result);
        selectizeCarrerasCorrer.refreshOptions();

      });

      function getCarrerasCorrer(callback){
        var mysql = require('mysql');
        var connection = mysql.createConnection({
          host     : 'localhost',
          user     : 'root',
          password : null,
          database : 'bicisoft'
        });

        connection.connect(function(err) {
          if(err){
            console.log(err.code);
            console.log(err.fatal);
          }
        });
        console.log("performing query");
        // Perform a query
        $query = 'SELECT * FROM carreras_no_finalizadas_view';
        connection.query($query, function(err, rows, fields) {
          if(err){
            console.log("An error ocurred performing the query.");
            console.log(err);
            return;
          }
          console.log("Query categorias succesfully executed");
          callback(err, rows);


        });

        // Close the connection
        connection.end(function(){
          // The connection has been closed
        });
      }

      //EMPIEZA configuracion TABLA

      // specify the columns
      var columnDefsCarrerasCorredores = [
      {headerName: "Pos", field: "posicion", sortable: true, width:65},
      {headerName: "Global", field: "global", sortable: true, width:75},
      {headerName: "#", field: "numero", filter: true, width:50},
      {headerName: "Nombre", field: "nombre", width:100},
      {headerName: "Apellido", field: "apellido", width:110},
      {headerName: "Categoria", field: "categoria", sortable: true, filter: true, width:95},
      {headerName: "Tiempo", field: "tiempo", width:80},
      {headerName: "Vueltas", field: "vueltas", width:80}
      ];

      // let the grid know which columns and what data to use
      var gridOptionsCarrerasCorredores = {
        defaultColDef: {
          resizable: false
        },
        columnDefs: columnDefsCarrerasCorredores,
      };

      // lookup the container we want the Grid to use
      var eGridDivCarrerasCorredores = document.querySelector('#gridCorredoresCarreras');

      getCorredoresCarreras(function (err, result){
        gridOptionsCarrerasCorredores.api.setRowData(result);
      });

      new agGrid.Grid(eGridDivCarrerasCorredores, gridOptionsCarrerasCorredores);


      //nuevo
      function getCorredoresCarreras(callback){
        var mysql = require('mysql');
        var connection = mysql.createConnection({
          host     : 'localhost',
          user     : 'root',
          password : null,
          database : 'bicisoft'
        });

        connection.connect(function(err) {
          if(err){
            console.log(err.code);
            console.log(err.fatal);
          }
        });
        console.log("performing query");
        // Perform a query
        $query = 'SELECT * FROM carrera_corredor_view WHERE id_carrera='+$idCarreraCorrer;
        connection.query($query, function(err, rows, fields) {
          if(err){
            console.log("An error ocurred performing the query.");
            console.log(err);
            return;
          }
          console.log("Query succesfully executed (carreras, corredores)");
          callback(err, rows);


        });

        // Close the connection
        connection.end(function(){
          // The connection has been closed
        });
      }

    </script>

  </section>
</template>
